<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'polls/styles.css' %}">
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap -->
    <link rel="stylesheet" href="{% static 'polls/bootstrap.min.css' %}">
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js "></script>

</head>
<body>
    <header class="text-center py-4 bg-white shadow-sm">
        <h1>–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    </header>
    <main>
        <div class="container">
            <div class="custom-wrapper">
                <section class="col-12 col-md-3 bg-light p-4 left-section">
                    <h2>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h2>
                    <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö:</p>
                    <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º" onkeyup="filterSubcategories()">
                    <ul id="category-list">
                        {% for category in categories %}
                            <li class="level-1">
                                <span class="emoji">{{ category.emoji }}</span> {{ category.name }}
                                <div class="subcategories" style="display: none;">
                                    <table>
                                        {% for subcategory in category.subcategories.all %}
                                            <tr class="subcategory">
                                                <td>{{ subcategory.name }}</td>
                                                <td><button class="toggle-button">‚Üí</button></td>
                                            </tr>
                                            <tr class="details" style="display: none;">
                                                <td colspan="2">{{ subcategory.description }}</td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </section>
                <script>
                    function filterSubcategories() {
                        const input = document.getElementById('search');
                        const filter = input.value.toLowerCase();
                        const categoryList = document.getElementById('category-list');
                        const categories = categoryList.getElementsByTagName('li');
                        for (let i = 0; i < categories.length; i++) {
                            const subcategories = categories[i].getElementsByClassName('subcategory');
                            let hasVisibleSubcategory = false;
                            for (let j = 0; j < subcategories.length; j++) {
                                const subcategoryName = subcategories[j].getElementsByTagName('td')[0].textContent || subcategories[j].getElementsByTagName('td')[0].innerText;
                                if (subcategoryName.toLowerCase().indexOf(filter) > -1) {
                                    subcategories[j].style.display = "";
                                    hasVisibleSubcategory = true;
                                } else {
                                    subcategories[j].style.display = "none";
                                }
                            }
                            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–ª–∏ —Å–∫—Ä—ã—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –≤–∏–¥–∏–º—ã—Ö –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
                            categories[i].getElementsByClassName('subcategories')[0].style.display = hasVisibleSubcategory ? "block" : "none";
                        }
                    }
                </script>
                <section class="col-12 col-md-9 bg-light p-4 right-section">
                    <h2>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º:</h2>
                    <section class="how-to-use my-3">
                        <div class="">
                            <ul class="list-group">
                                <!-- –®–∞–≥ 1 -->
                                <li class="list-group-item d-flex align-items-start">
                                    <span class="me-3 fs-4">1Ô∏è‚É£</span>
                                    <div>
                                        <h5 class="fw-bold mb-1">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</h5>
                                        <p class="mb-0">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>.csv</code>. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.</p>
                                    </div>
                                </li>
                                <!-- –®–∞–≥ 2 -->
                                <li class="list-group-item d-flex align-items-start">
                                    <span class="me-3 fs-4">2Ô∏è‚É£</span>
                                    <div>
                                        <h5 class="fw-bold mb-1">–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
                                        <p class="mb-0">–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ. –ü—Ä–æ—Å–∏–º –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞.</p>
                                    </div>
                                </li>
                                <!-- –®–∞–≥ 3 -->
                                <li class="list-group-item d-flex align-items-start">
                                    <span class="me-3 fs-4">3Ô∏è‚É£</span>
                                    <div>
                                        <h5 class="fw-bold mb-1">–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏ —Å–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã </h5>
                                        <p class="mb-0">–ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞. –¢–∞–∫–∂–µ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π CSV-—Ñ–∞–π–ª.</p>
                                    </div>
                                </li>
                            </ul>
                            <p class="mb-0">* –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ 1-–º—É —Å—Ç–æ–ª–±—Ü—É –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ</p>
                        </div>
                    </section>
                    <h2 class="display-6 text-black mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ CSV -->
                    <form id="upload-form" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <label for="file-upload" class="form-label mb-2">–í—ã–±–µ—Ä–∏—Ç–µ CSV-—Ñ–∞–π–ª:</label>
                        <div class="d-flex align-items-center gap-2" style="max-width: 500px;">
                            <input class="form-control" type="file" name="file" id="file-upload" accept=".csv">
                            <button type="submit" class="btn btn-primary" id="upload-btn" style="display: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        </div>
                    </form>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const fileInput = document.getElementById('file-upload');
                            const uploadBtn = document.getElementById('upload-btn');
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –∏ –º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å input
                            fileInput.addEventListener('change', function () {
                                if (fileInput.files.length > 0) {
                                    uploadBtn.style.display = 'inline-block';
                                    fileInput.classList.add('file-selected'); // —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
                                } else {
                                    uploadBtn.style.display = 'none';
                                    fileInput.classList.remove('file-selected'); // —Å–∏–Ω–∏–π —Ü–≤–µ—Ç
                                }
                            });
                        });
                    </script>
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                    <div class="progress mt-3 hidden" id="progress-bar">
                        <div class="progress-bar" id="progress-bar-fill" role="progressbar" style="width: 0%;"></div>
                    </div>
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                    <section id="results-section" class="hidden mt-4">
                        <div class="d-flex align-items-center justify-content-between mt-4" id="download-row">
                            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫):</h3>
                            <a id="download-link" class="btn btn-success hidden" download>–°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª</a>
                        </div>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th class="col-6">–¢–µ–∫—Å—Ç</th>
                                    <th class="col-4">–ú–µ—Ç–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody id="results-table-body">
                                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ -->
                            </tbody>
                        </table>
                        
                        <div id="charts-section" class="hidden">
                            <div id="charts-container"></div>
                        </div>
                    </section>
                </section>
            </div>
        </div>
    </main>
    <footer>
        <p>¬© 2025 –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–º –ü–ª–µ—Å—Å–∫–æ–π –û.–í. –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–µ–¥–¥–∏–ø–ª–æ–º–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏.</p>
    </footer>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.querySelectorAll('.left-section li').forEach(category => {
            category.addEventListener('click', function () {
                const subcategories = this.querySelector('.subcategories');
                if (subcategories.style.display === 'block') {
                    subcategories.style.display = 'none';
                } else {
                    subcategories.style.display = 'block';
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
        document.querySelectorAll('.toggle-button').forEach(button => {
            button.addEventListener('click', function (event) {
                event.stopPropagation();
                
                const detailsRow = this.closest('tr').nextElementSibling;
                const subcategoryRow = this.closest('tr');    
                if (detailsRow.style.display === 'table-row') {
                    detailsRow.style.display = 'none';
                    this.textContent = '‚Üí';
                    subcategoryRow.classList.remove('active'); // –£–±–∏—Ä–∞–µ–º —Å–µ—Ä—ã–π —Ü–≤–µ—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    detailsRow.classList.remove('active');      // –£–±–∏—Ä–∞–µ–º —Å–µ—Ä—ã–π —Ü–≤–µ—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è
                } else {
                    detailsRow.style.display = 'table-row';
                    this.textContent = '‚Üì';
                    subcategoryRow.classList.add('active'); // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä—ã–π —Ü–≤–µ—Ç –∫ —Å—Ç—Ä–æ–∫–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    detailsRow.classList.add('active');      // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä—ã–π —Ü–≤–µ—Ç –∫ —Å—Ç—Ä–æ–∫–µ –æ–ø–∏—Å–∞–Ω–∏—è
                }
            });
        });

        $(document).ready(function () {
        $('#upload-form').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            $('#progress-bar').removeClass('hidden');
            $('#progress-bar-fill').css('width', '0%');
            $('#results-section').addClass('hidden');
            $('#download-link').addClass('hidden');
            $('#charts-section').addClass('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    
            $.ajax({
                url: '',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function () {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function (event) {
                        if (event.lengthComputable) {
                            const percentComplete = (event.loaded / event.total) * 100;
                            $('#progress-bar-fill').css('width', percentComplete + '%');
                        }
                    });
                    return xhr;
                },
                success: function (response) {
                    const tbody = $('#results-table-body');
                    tbody.empty();
    
                    // === –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ===
                    response.preview.forEach(row => {
                        const labels = row.predicted_labels.split('; ').map(label => label.trim());
                        const badges = labels.map(label => `<span class="badge bg-primary me-1 mb-1 badge-multiline">${label}</span>`).join('');
                        
                        tbody.append(`
                          <tr>
                            <td>${row.text}</td>
                            <td>
                              <div class="d-flex flex-wrap">
                                ${badges}
                              </div>
                            </td>
                          </tr>
                        `);
                    });
    
                    // === –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ===
                    $('#results-section').removeClass('hidden');
    
                    // === –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV ===
                    $('#download-link')
                        .attr('href', response.download_url)
                        .removeClass('hidden');
    
                    // === –ß–∏—Å—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–æ–π ===
                    $('#charts-container').empty();
    
                    // === –î–æ–±–∞–≤–ª—è–µ–º –æ–±–ª–∞–∫–æ —Å–ª–æ–≤ ===
                    if (response.wordcloud_url) {
                        $('#charts-container').append(`
                            <h3 class="mt-4">‚òÅÔ∏è –û–±–ª–∞–∫–æ —Å–ª–æ–≤:</h3>
                            <div class="chart-container mt-3">
                                <img src="${response.wordcloud_url}" alt="–û–±–ª–∞–∫–æ —Å–ª–æ–≤" class="img-fluid rounded shadow-sm">
                            </div>
                        `);
                    }
    
                    // === –ì—Ä–∞—Ñ–∏–∫ 1: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ===
                    if (response.graph1_url) {
                        $('#charts-container').append(`
                            <h3 class="mt-4">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h3>
                            <div class="chart-container mt-3">
                                <img src="${response.graph1_url}" alt="–ì—Ä–∞—Ñ–∏–∫ 1" class="img-fluid rounded shadow-sm">
                            </div>
                        `);
                    }
    
                    // === –ì—Ä–∞—Ñ–∏–∫ 2: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ===
                    if (response.graph2_url) {
                        $('#charts-container').append(`
                            <h3 class="mt-4">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h3>
                            <div class="chart-container mt-3">
                                <img src="${response.graph2_url}" alt="–ì—Ä–∞—Ñ–∏–∫ 2" class="img-fluid rounded shadow-sm">
                            </div>
                        `);
                    }
    
                    // === –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å ===
                    if (response.graph1_url || response.graph2_url || response.wordcloud_url) {
                        $('#charts-section').removeClass('hidden');
                    } else {
                        $('#charts-section').addClass('hidden');
                    }
    
                    // === –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä —Å–∫—Ä—ã–≤–∞–µ–º ===
                    $('#progress-bar').addClass('hidden');
                },
                error: function (xhr) {
                    alert('–û—à–∏–±–∫–∞: ' + xhr.responseJSON.error);
                    $('#progress-bar').addClass('hidden');
                }
            });
        });
    
        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë/–°–∫—Ä—ã—Ç—å" ===
        $(document).on('click', '.toggle-text', function () {
            const container = $(this).closest('.text-truncate-cell');
            const truncatedText = container.find('.truncated-text');
            const fullText = container.find('.full-text');
    
            truncatedText.toggleClass('d-none');
            fullText.toggleClass('d-none');
    
            $(this).text(function (i, text) {
                return text === '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë' ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë';
            });
        });
    });
    </script>
</body>
</html>